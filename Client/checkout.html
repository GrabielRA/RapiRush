<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - DeliveryApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-warning" href="index.html">
              <h3> DeliveryApp</h3>
            </a>
            <div class="text-muted">
                <i class="bi bi-lock-fill"></i> Pago seguro
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container my-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="carrito.html">Carrito</a></li>
                <li class="breadcrumb-item active">Checkout</li>
            </ol>
        </nav>
    </div>

    <!-- Contenido Principal -->
    <div class="container my-4">
        <h2 class="fw-bold mb-4">Finalizar pedido</h2>

        <div class="row">
            <!-- Formulario de datos -->
            <div class="col-lg-7">
                <!-- Informaci贸n de entrega -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-3">
                            <i class="bi bi-geo-alt-fill text-primary"></i> Informaci贸n de entrega
                        </h5>
                        
                        <form id="checkout-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="firstName" class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="lastName" class="form-label">Apellido *</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="phone" class="form-label">Tel茅fono *</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-12">
                                    <label for="address" class="form-label">Direcci贸n *</label>
                                    <input type="text" class="form-control" id="address" placeholder="Calle, n煤mero, distrito" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="reference" class="form-label">Referencia</label>
                                    <input type="text" class="form-control" id="reference" placeholder="Ej: Casa azul, al lado del parque">
                                </div>
                                <div class="col-md-6">
                                    <label for="district" class="form-label">Distrito *</label>
                                    <select class="form-select" id="district" required>
                                        <option value="">Seleccionar distrito</option>
                                        <option value="miraflores">Miraflores</option>
                                        <option value="san-isidro">San Isidro</option>
                                        <option value="surco">Surco</option>
                                        <option value="la-molina">La Molina</option>
                                        <option value="san-borja">San Borja</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="notes" class="form-label">Notas adicionales</label>
                                    <textarea class="form-control" id="notes" rows="2" placeholder="Instrucciones especiales para el repartidor"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- M茅todos de pago -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-3">
                            <i class="bi bi-credit-card-fill text-primary"></i> M茅todo de pago
                        </h5>

                        <div class="payment-methods">
                            <!-- Efectivo -->
                            <div class="form-check payment-card mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="cash" checked>
                                <label class="form-check-label d-flex align-items-center w-100" for="cash">
                                    <i class="bi bi-cash-coin fs-3 me-3 text-success"></i>
                                    <div>
                                        <strong>Efectivo</strong>
                                        <p class="mb-0 small text-muted">Paga al recibir tu pedido</p>
                                    </div>
                                </label>
                            </div>

                            <!-- Tarjeta de cr茅dito/d茅bito -->
                            <div class="form-check payment-card mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card">
                                <label class="form-check-label d-flex align-items-center w-100" for="card">
                                    <i class="bi bi-credit-card fs-3 me-3 text-primary"></i>
                                    <div>
                                        <strong>Tarjeta de cr茅dito/d茅bito</strong>
                                        <p class="mb-0 small text-muted">Visa, Mastercard, American Express</p>
                                    </div>
                                </label>
                            </div>

                            <!-- Yape/Plin -->
                            <div class="form-check payment-card mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="digital" value="digital">
                                <label class="form-check-label d-flex align-items-center w-100" for="digital">
                                    <i class="bi bi-phone fs-3 me-3 text-info"></i>
                                    <div>
                                        <strong>Yape / Plin</strong>
                                        <p class="mb-0 small text-muted">Pago digital instant谩neo</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Secci贸n de datos de tarjeta (oculta por defecto) -->
                        <div id="card-details-section" class="card-details-section" style="display: none;">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-shield-lock-fill"></i> Datos de la tarjeta
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="cardNumber" class="form-label">N煤mero de tarjeta *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="cardNumber" 
                                               placeholder="1234 5678 9012 3456" maxlength="19">
                                        <span class="input-group-text">
                                            <i class="bi bi-credit-card-2-front"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="cardName" class="form-label">Nombre en la tarjeta *</label>
                                    <input type="text" class="form-control" id="cardName" 
                                           placeholder="Como aparece en la tarjeta">
                                </div>
                                <div class="col-md-6">
                                    <label for="cardExpiry" class="form-label">Fecha de expiraci贸n *</label>
                                    <input type="text" class="form-control" id="cardExpiry" 
                                           placeholder="MM/AA" maxlength="5">
                                </div>
                                <div class="col-md-6">
                                    <label for="cardCvv" class="form-label">CVV *</label>
                                    <input type="text" class="form-control" id="cardCvv" 
                                           placeholder="123" maxlength="4">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> 3 o 4 d铆gitos al reverso
                                    </small>
                                </div>
                            </div>

                            <div class="alert alert-info mt-3 mb-0">
                                <i class="bi bi-shield-check"></i>
                                <small>Tu informaci贸n est谩 protegida con encriptaci贸n SSL de 256 bits</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot贸n de confirmar -->
                <div class="d-grid gap-2 mb-4">
                    <button type="button" class="btn btn-primary btn-lg" onclick="confirmOrder()">
                        <i class="bi bi-check-circle"></i> Confirmar pedido
                    </button>
                    <a href="carrito.html" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al carrito
                    </a>
                </div>
            </div>

            <!-- Resumen del pedido (sticky) -->
            <div class="col-lg-5">
                <div class="order-summary">
                    <h5 class="fw-bold mb-4">Resumen del pedido</h5>

                    <!-- Items del pedido -->
                    <div id="order-items-list" class="mb-3">
                        <!-- Se llenar谩 din谩micamente -->
                    </div>

                    <hr>

                    <!-- Desglose de precios -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal</span>
                        <span id="summary-subtotal">S/. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery</span>
                        <span id="summary-delivery">S/. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Descuento</span>
                        <span id="summary-discount">- S/. 0.00</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <strong class="fs-5">Total</strong>
                        <strong class="text-primary fs-4" id="summary-total">S/. 0.00</strong>
                    </div>

                    <!-- Tiempo estimado -->
                    <div class="alert alert-success">
                        <i class="bi bi-clock-fill"></i>
                        <strong>Tiempo estimado:</strong> 30-40 min
                    </div>

                    <!-- Informaci贸n adicional -->
                    <div class="small text-muted mt-3">
                        <p class="mb-1">
                            <i class="bi bi-check-circle-fill text-success"></i> 
                            Pago 100% seguro
                        </p>
                        <p class="mb-1">
                            <i class="bi bi-check-circle-fill text-success"></i> 
                            Seguimiento en tiempo real
                        </p>
                        <p class="mb-0">
                            <i class="bi bi-check-circle-fill text-success"></i> 
                            Garant铆a de satisfacci贸n
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci贸n -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    <h3 class="mt-3 fw-bold">隆Pedido confirmado!</h3>
                    <p class="text-muted">Tu pedido ha sido recibido y est谩 siendo preparado</p>
                    <p class="fw-bold">N煤mero de pedido: #<span id="order-number"></span></p>
                    <div class="d-grid gap-2 mt-4">
                        <a href="dashboard/cliente.html" class="btn btn-primary">Ver mis pedidos</a>
                        <a href="index.html" class="btn btn-outline-secondary">Volver al inicio</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mostrar/ocultar secci贸n de tarjeta
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const cardSection = document.getElementById('card-details-section');
                if (this.value === 'card') {
                    cardSection.style.display = 'block';
                } else {
                    cardSection.style.display = 'none';
                }
            });
        });

        // Formatear n煤mero de tarjeta
        document.getElementById('cardNumber')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Formatear fecha de expiraci贸n
        document.getElementById('cardExpiry')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Cargar resumen del pedido
        function loadOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            if (cart.length === 0) {
                window.location.href = 'carrito.html';
                return;
            }

            const itemsList = document.getElementById('order-items-list');
            let itemsHTML = '';
            
            cart.forEach(item => {
                itemsHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary me-2">${item.quantity}x</span>
                            <span class="small">${item.name}</span>
                        </div>
                        <span class="small fw-bold">S/. ${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            });
            
            itemsList.innerHTML = itemsHTML;

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            // delivery fee
            let delivery = 5.00;
            if (subtotal === 0) delivery = 0;
            if (subtotal >= 50) delivery = 0; // Delivery gratis para pedidos mayores a S/.50

            // Leer promo desde localStorage (aplicado desde carrito)
            let discount = 0;
            try{
                const promoRaw = localStorage.getItem('promoCode');
                if(promoRaw){
                    const promo = JSON.parse(promoRaw);
                    if(promo){
                        if(promo.type === 'percentage'){
                            discount = +(subtotal * (promo.value/100));
                        } else if(promo.type === 'fixed'){
                            discount = +(promo.value);
                        } else if(promo.type === 'delivery'){
                            // delivery free
                            delivery = 0;
                            discount = 0;
                        }
                    }
                }
            }catch(e){ console.warn('Error reading promo', e); }

            const total = subtotal + delivery - discount;

            document.getElementById('summary-subtotal').textContent = `S/. ${subtotal.toFixed(2)}`;
            document.getElementById('summary-delivery').textContent = `S/. ${delivery.toFixed(2)}`;
            document.getElementById('summary-discount').textContent = `- S/. ${discount.toFixed(2)}`;
            document.getElementById('summary-total').textContent = `S/. ${total.toFixed(2)}`;
        }

        // Confirmar pedido
        function confirmOrder() {
            const form = document.getElementById('checkout-form');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // Si es tarjeta, validar campos adicionales
            if (paymentMethod === 'card') {
                const cardNumber = document.getElementById('cardNumber').value;
                const cardName = document.getElementById('cardName').value;
                const cardExpiry = document.getElementById('cardExpiry').value;
                const cardCvv = document.getElementById('cardCvv').value;
                
                if (!cardNumber || !cardName || !cardExpiry || !cardCvv) {
                    alert('Por favor completa todos los datos de la tarjeta');
                    return;
                }
            }

                // Generar n煤mero de pedido
                const orderNumber = Math.floor(100000 + Math.random() * 900000);
                document.getElementById('order-number').textContent = orderNumber;

                // Crear objeto order y guardarlo en la sesi贸n del usuario
                (function(){
                    try{
                        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        // compute delivery
                        let delivery = 5.00;
                        if (subtotal === 0) delivery = 0;
                        if (subtotal >= 50) delivery = 0;

                        // compute discount from promo (same logic as summary)
                        let discount = 0;
                        try{
                            const promoRaw = localStorage.getItem('promoCode');
                            if(promoRaw){
                                const promo = JSON.parse(promoRaw);
                                if(promo){
                                    if(promo.type === 'percentage'){
                                        discount = +(subtotal * (promo.value/100));
                                    } else if(promo.type === 'fixed'){
                                        discount = +(promo.value);
                                    } else if(promo.type === 'delivery'){
                                        delivery = 0;
                                        discount = 0;
                                    }
                                }
                            }
                        }catch(e){ console.warn('Error reading promo', e); }

                        const total = subtotal + delivery - discount;

                        const user = window.Session && window.Session.getUser ? window.Session.getUser() : null;
                        const nowTs = Date.now();
                        const isoNow = new Date(nowTs).toISOString();

                        // Determine first interval from Session config if available (fallback 2 minutes)
                        var firstInterval = 2 * 60 * 1000;
                        try{
                            if(window.Session && window.Session.ORDER_PROGRESS_CONFIG && Array.isArray(window.Session.ORDER_PROGRESS_CONFIG.intervals)){
                                firstInterval = window.Session.ORDER_PROGRESS_CONFIG.intervals[0] || firstInterval;
                            }
                        }catch(e){ }

                        const order = {
                            id: orderNumber,
                            date: isoNow,
                            items: cart,
                            subtotal: subtotal,
                            delivery: delivery,
                            discount: discount,
                            total: total,
                            status: 'pendiente',
                            email: (user && user.email) ? user.email : document.getElementById('email').value || null,
                            name: (user && user.name) ? user.name : (document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value),
                            // Tracking timeline: inicial step uses order.date
                            tracking: [
                                { step: 'Pedido recibido', key: 'received', description: 'Hemos recibido tu pedido', time: isoNow }
                            ],
                            // programar el siguiente avance autom谩tico at date + firstInterval
                            nextStepAt: nowTs + firstInterval
                        };

                        if(window.Session && window.Session.addOrder){
                            window.Session.addOrder(order);
                        } else {
                            // fallback: store under orders_<email>
                            if(order.email){
                                const key = 'orders_' + order.email.toLowerCase();
                                const existing = JSON.parse(localStorage.getItem(key) || '[]');
                                existing.unshift(order);
                                localStorage.setItem(key, JSON.stringify(existing));
                            }
                        }

                        // Limpiar carrito
                        localStorage.removeItem('cart');

                    }catch(e){
                        console.warn('Error saving order', e);
                    }
                })();

                // Mostrar modal de confirmaci贸n
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
        }

        // Cargar al iniciar
        loadOrderSummary();
    </script>
    <script src="assets/js/session.js"></script>
</body>
</html>